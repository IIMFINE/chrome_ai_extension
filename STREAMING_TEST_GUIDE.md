# 流式回复测试指南

## 快速测试

### 1. 重新加载扩展
1. 打开 Chrome 浏览器
2. 访问 `chrome://extensions/`
3. 找到 "AI网页助手" 扩展
4. 点击 "重新加载" 按钮（🔄图标）

### 2. 打开测试页面
1. 访问任意网页（如维基百科文章）
2. 点击扩展图标或打开侧边栏

### 3. 测试流式回复
发送以下测试问题：

#### 测试 1：短回复
```
总结这个页面的主要内容
```
**预期结果**：看到文字逐个出现，类似打字效果

#### 测试 2：长回复
```
详细分析这个页面的所有内容，并列出所有要点
```
**预期结果**：
- 文字持续出现，不会中断
- 没有截断现象
- 完整的回复显示

#### 测试 3：代码回复
```
如何用 JavaScript 实现这个功能？请给出示例代码
```
**预期结果**：
- 流式过程中看到纯文本
- 完成后代码块正确高亮显示

## 检查点

### ✅ 正常工作的标志
- [ ] 看到文字逐个/逐段出现
- [ ] 状态栏显示 "🤖 正在接收回复..."
- [ ] 长回复完整显示，无截断
- [ ] Markdown 格式正确渲染（sidepanel）
- [ ] 代码块有语法高亮（sidepanel）

### ❌ 问题标志
- [ ] 文字一次性全部显示（未启用流式）
- [ ] 回复被截断
- [ ] 显示 "流式响应错误" 消息
- [ ] Markdown 渲染失败

## 调试步骤

### 1. 检查浏览器控制台
打开 DevTools (F12)，查看：
- **Popup/Sidepanel 控制台**：前端错误
- **Service Worker 控制台**：
  1. 访问 `chrome://extensions/`
  2. 点击 "Service Worker" 链接
  3. 查看 background.js 错误

### 2. 查看网络请求
1. 打开 Network 标签
2. 查找 POST 请求到 API endpoint
3. 检查请求参数：
   ```json
   {
     "stream": true,
     "max_tokens": 4000
   }
   ```

### 3. 验证 API 支持
确认你的 API 提供商支持流式响应：
- OpenAI API: ✅ 支持
- Azure OpenAI: ✅ 支持
- 自定义 API: ⚠️ 需要检查文档

## 常见问题

### Q: 没有看到流式效果
**A:** 
1. 检查 API Endpoint 是否正确
2. 确认 API 支持 `stream: true`
3. 查看控制台是否有错误

### Q: 出现 "流式响应错误"
**A:**
1. 检查 API Key 是否有效
2. 确认网络连接正常
3. 查看具体错误信息（控制台）

### Q: Markdown 不渲染
**A:**
1. 确认在 sidepanel 中测试（popup 不支持 Markdown）
2. 检查 marked.js 和 highlight.js 是否加载
3. 查看控制台是否有 Markdown 解析错误

### Q: 回复仍然被截断
**A:**
1. 检查 API 提供商的 token 限制
2. 可以在 background.js 中增加 `max_tokens`
3. 考虑使用支持更长上下文的模型

## 性能测试

### 测试场景 1：普通网页
- **页面**：新闻文章
- **问题**："总结这篇文章"
- **预期时间**：5-10 秒
- **预期效果**：平滑的流式输出

### 测试场景 2：长文档
- **页面**：技术文档（如 MDN）
- **问题**："详细解释这个 API"
- **预期时间**：10-20 秒
- **预期效果**：持续的流式输出，无卡顿

### 测试场景 3：复杂查询
- **页面**：GitHub 仓库
- **问题**："分析这个项目的结构和技术栈"
- **预期时间**：15-30 秒
- **预期效果**：长回复完整显示

## 对比测试

### 非流式模式（修改前）
- ⏱️ 等待时间：10-30 秒无反馈
- 📊 回复完整性：可能截断
- 👤 用户体验：等待焦虑

### 流式模式（修改后）
- ⏱️ 首字节时间：1-3 秒
- 📊 回复完整性：完整显示
- 👤 用户体验：实时反馈，无等待焦虑

## 回退方案

如果流式模式出现问题，可以临时回退：

### 在 sidepanel.js 中
```javascript
// 找到 sendMessage 函数
// 将这一行：
await callStreamAPI(messages);

// 改回：
const response = await callAPI(messages);
// 并恢复原来的处理逻辑
```

### 在 popup.js 中
同样的修改

## 报告问题

如果遇到问题，请提供：
1. 浏览器版本
2. 错误信息（控制台截图）
3. API Endpoint 类型
4. 复现步骤

---

祝测试顺利！🚀
